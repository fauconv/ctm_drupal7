
(function(b){function c(d){this.version="2.2";this.buildDate="2009/08/12 22:18";this.buildNumber="113";this.config={};this.is_drawing=0;this.strings=[];this.memory=[];this.areas=[];this.eventHandlers={};this.currentid=0;this.draggedId=null;this.selectedId=null;this.nextShape="rect";this.isLoaded=false;this.mapname="";this.mapid="";this.globalscale=1;this.DM_RECTANGLE_DRAW=1;this.DM_RECTANGLE_MOVE=11;this.DM_RECTANGLE_RESIZE_TOP=12;this.DM_RECTANGLE_RESIZE_RIGHT=13;this.DM_RECTANGLE_RESIZE_BOTTOM=14;this.DM_RECTANGLE_RESIZE_LEFT=15;this.DM_SQUARE_DRAW=2;this.DM_SQUARE_MOVE=21;this.DM_SQUARE_RESIZE_TOP=22;this.DM_SQUARE_RESIZE_RIGHT=23;this.DM_SQUARE_RESIZE_BOTTOM=24;this.DM_SQUARE_RESIZE_LEFT=25;this.DM_POLYGON_DRAW=3;this.DM_POLYGON_LASTDRAW=30;this.DM_POLYGON_MOVE=31;this.config.custom_callbacks={};this.event_types=["onAddArea","onRemoveArea","onDrawArea","onResizeArea","onMoveArea","onLoadImage","onSelectArea","onStatusMessage","onAreaChanged"];this.config.CL_DRAW_SHAPE="#d00";this.config.CL_DRAW_BG="#fff";this.config.CL_NORM_SHAPE="#d00";this.config.CL_NORM_BG="#fff";this.config.CL_HIGHLIGHT_SHAPE="#d00";this.config.CL_HIGHLIGHT_BG="#fff";this.config.CL_KNOB="#555";this.config.bounding_box=true;this.config.label="%n";this.config.label_class="imgmap_label";this.config.label_style="font: bold 10px Arial";this.config.hint="#%n %h";this.config.draw_opacity="35";this.config.norm_opacity="50";this.config.highlight_opacity="70";this.config.cursor_default="crosshair";var e=navigator.userAgent;this.isMSIE=(navigator.appName=="Microsoft Internet Explorer");this.isSafari=e.indexOf("Safari")!=-1;this.setup(d)}b.imgmap=c;c.prototype.assignOID=function(e){try{if(typeof e=="undefined"){this.log("Undefined object passed to assignOID.");return null}else{if(typeof e=="object"){return e}else{if(typeof e=="string"){return document.getElementById(e)}}}}catch(d){this.log("Error in assignOID",1)}return null};c.prototype.setup=function(e){for(var g in e){if(e.hasOwnProperty(g)){this.config[g]=e[g]}}this.addEvent(document,"keydown",this.eventHandlers.doc_keydown=this.doc_keydown.bind(this));this.addEvent(document,"keyup",this.eventHandlers.doc_keyup=this.doc_keyup.bind(this));this.addEvent(document,"mousedown",this.eventHandlers.doc_mousedown=this.doc_mousedown.bind(this));if(e&&e.pic_container){this.pic_container=this.assignOID(e.pic_container);this.disableSelection(this.pic_container)}var h,d,f;for(g in this.config.custom_callbacks){if(this.config.custom_callbacks.hasOwnProperty(g)){h=false;for(d=0,f=this.event_types.length;d<f;d++){if(g==this.event_types[d]){h=true;break}}if(!h){this.log("Unknown custom callback: "+g,1)}}}return true};c.prototype.loadStrings=function(e){for(var d in e){if(e.hasOwnProperty(d)){this.strings[d]=e[d]}}};c.prototype.addEvent=function(e,d,f){if(e.addEventListener){e.addEventListener(d,f,false);return true}else{return e.attachEvent("on"+d,f)}};c.prototype.removeEvent=function(e,d,f){if(e.removeEventListener){e.removeEventListener(d,f,false);return true}else{return e.detachEvent("on"+d,f)}};c.prototype.loadImage=function(d,e,f){if(typeof this.pic_container=="undefined"){this.log("You must have pic_container defined to use loadImage!",2);return false}this.removeAllAreas();this.globalscale=1;if(typeof this.pic=="undefined"){this.pic=document.createElement("IMG");this.pic_container.appendChild(this.pic);this.addEvent(this.pic,"mousedown",this.eventHandlers.img_mousedown=this.img_mousedown.bind(this));this.addEvent(this.pic,"mouseup",this.eventHandlers.img_mouseup=this.img_mouseup.bind(this));this.addEvent(this.pic,"mousemove",this.eventHandlers.img_mousemove=this.img_mousemove.bind(this));this.pic.style.cursor=this.config.cursor_default}this.pic.src=d;if(e&&e>0){this.pic.setAttribute("width",e)}if(f&&f>0){this.pic.setAttribute("height",f)}this.fireEvent("onLoadImage",this.pic);return true};c.prototype.statusMessage=function(d){this.fireEvent("onStatusMessage",d)};c.prototype.log=function(d,e){};c.prototype.getMapName=function(){if(this.mapname===""){if(this.mapid!==""){return this.mapid}var d=new Date();this.mapname="imgmap"+d.getFullYear()+(d.getMonth()+1)+d.getDate()+d.getHours()+d.getMinutes()+d.getSeconds()}return this.mapname};c.prototype.getMapId=function(){if(this.mapid===""){this.mapid=this.getMapName()}return this.mapid};c.prototype._normShape=function(d){if(!d){return"rect"}d=a(d).toLowerCase();if(d.substring(0,4)=="rect"){return"rect"}if(d.substring(0,4)=="circ"){return"circle"}if(d.substring(0,4)=="poly"){return"poly"}return"rect"};c.prototype._normCoords=function(v,d,w){var x;var p;var n;var m;var l;var A,q;v=a(v);if(v===""){return""}var s=v;v=v.replace(/(\d)([^\d\.])+(\d)/g,"$1,$3");v=v.replace(/,\D+(\d)/g,",$1");v=v.replace(/,0+(\d)/g,",$1");v=v.replace(/(\d)(\D)+,/g,"$1,");v=v.replace(/^\D+(\d)/g,"$1");v=v.replace(/^0+(\d)/g,"$1");v=v.replace(/(\d)(\D)+$/g,"$1");var t=v.split(",");if(d=="rect"){if(w=="fromcircle"){var o=t[2];t[0]=t[0]-o;t[1]=t[1]-o;t[2]=parseInt(t[0],10)+2*o;t[3]=parseInt(t[1],10)+2*o}else{if(w=="frompoly"){p=parseInt(t[0],10);m=parseInt(t[0],10);n=parseInt(t[1],10);l=parseInt(t[1],10);for(x=0,q=t.length;x<q;x++){if(x%2===0&&parseInt(t[x],10)<p){p=parseInt(t[x],10)}if(x%2===1&&parseInt(t[x],10)<n){n=parseInt(t[x],10)}if(x%2===0&&parseInt(t[x],10)>m){m=parseInt(t[x],10)}if(x%2===1&&parseInt(t[x],10)>l){l=parseInt(t[x],10)}}t[0]=p;t[1]=n;t[2]=m;t[3]=l}}if(!(parseInt(t[1],10)>=0)){t[1]=t[0]}if(!(parseInt(t[2],10)>=0)){t[2]=parseInt(t[0],10)+10}if(!(parseInt(t[3],10)>=0)){t[3]=parseInt(t[1],10)+10}if(parseInt(t[0],10)>parseInt(t[2],10)){A=t[0];t[0]=t[2];t[2]=A}if(parseInt(t[1],10)>parseInt(t[3],10)){A=t[1];t[1]=t[3];t[3]=A}v=t[0]+","+t[1]+","+t[2]+","+t[3]}else{if(d=="circle"){if(w=="fromrect"){p=parseInt(t[0],10);m=parseInt(t[2],10);n=parseInt(t[1],10);l=parseInt(t[3],10);t[2]=(m-p<l-n)?m-p:l-n;t[2]=Math.floor(t[2]/2);t[0]=p+t[2];t[1]=n+t[2]}else{if(w=="frompoly"){p=parseInt(t[0],10);m=parseInt(t[0],10);n=parseInt(t[1],10);l=parseInt(t[1],10);for(x=0,q=t.length;x<q;x++){if(x%2===0&&parseInt(t[x],10)<p){p=parseInt(t[x],10)}if(x%2===1&&parseInt(t[x],10)<n){n=parseInt(t[x],10)}if(x%2===0&&parseInt(t[x],10)>m){m=parseInt(t[x],10)}if(x%2===1&&parseInt(t[x],10)>l){l=parseInt(t[x],10)}}t[2]=(m-p<l-n)?m-p:l-n;t[2]=Math.floor(t[2]/2);t[0]=p+t[2];t[1]=n+t[2]}}if(!(parseInt(t[1],10)>0)){t[1]=t[0]}if(!(parseInt(t[2],10)>0)){t[2]=10}v=t[0]+","+t[1]+","+t[2]}else{if(d=="poly"){if(w=="fromrect"){t[4]=t[2];t[5]=t[3];t[2]=t[0];t[6]=t[4];t[7]=t[1]}else{if(w=="fromcircle"){var k=parseInt(t[0],10);var h=parseInt(t[1],10);var e=parseInt(t[2],10);var u=0;t[u++]=k+e;t[u++]=h;var z=60;for(x=0;x<=z;x++){var B=x/z;var y=Math.cos(B*2*Math.PI);var C=Math.sin(B*2*Math.PI);var g=k+y*e;var f=h+C*e;t[u++]=Math.round(g);t[u++]=Math.round(f)}}}v=t.join(",")}}}if(w=="preserve"&&s!=v){return s}return v};c.prototype.setMapHTML=function(e){this.fireEvent("onSetMap",e);this.removeAllAreas();var h;if(typeof e=="string"){var r=document.createElement("DIV");r.innerHTML=e;h=r.firstChild}else{if(typeof e=="object"){h=e}}if(!h||h.nodeName.toLowerCase()!=="map"){return false}this.mapname=h.name;this.mapid=h.id;var l=h.getElementsByTagName("area");var n,p,f,k,o,m,g;for(var j=0,d=l.length;j<d;j++){n=p=f=k=o=m="";g=this.addNewArea();n=this._normShape(l[j].getAttribute("shape",2));this.initArea(g,n);if(l[j].getAttribute("coords",2)){p=this._normCoords(l[j].getAttribute("coords",2),n);this.areas[g].lastInput=p}f=l[j].getAttribute("href",2);var q=l[j].getAttribute("data-cke-saved-href");if(q){f=q}if(f){this.areas[g].ahref=f}k=l[j].getAttribute("alt");if(k){this.areas[g].aalt=k}o=l[j].getAttribute("title");if(!o){o=k}if(o){this.areas[g].atitle=o}m=l[j].getAttribute("target");if(m){m=m.toLowerCase()}this.areas[g].atarget=m;this._recalculate(g,p);this.relaxArea(g);this.fireEvent("onAreaChanged",this.areas[g])}return true};c.prototype.addNewArea=function(){var e=this._getLastArea();var f=(e)?e.aid+1:0;var d=this.areas[f]=document.createElement("DIV");d.id=this.mapname+"area"+f;d.aid=f;d.shape="undefined";this.blurArea(this.currentid);this.currentid=f;this.fireEvent("onAddArea",f);return f};c.prototype.initArea=function(f,d){var e=this.areas[f];if(!e){return}if(e.parentNode){e.parentNode.removeChild(e)}if(e.label){e.label.parentNode.removeChild(e.label)}e=this.areas[f]=document.createElement("CANVAS");this.pic_container.appendChild(e);this.pic_container.style.position="relative";if(typeof G_vmlCanvasManager!="undefined"){e=this.areas[f]=G_vmlCanvasManager.initElement(e)}e.id=this.mapname+"area"+f;e.aid=f;e.shape=d;e.ahref="";e.atitle="";e.aalt="";e.atarget="";e.style.position="absolute";e.style.top=this.pic.offsetTop+"px";e.style.left=this.pic.offsetLeft+"px";this._setopacity(e,this.config.CL_DRAW_BG,this.config.draw_opacity);e.onmousedown=this.area_mousedown.bind(this);e.onmouseup=this.area_mouseup.bind(this);e.onmousemove=this.area_mousemove.bind(this);e.onmouseover=this.area_mouseover.bind(this);e.onmouseout=this.area_mouseout.bind(this);this.memory[f]={};this.memory[f].downx=0;this.memory[f].downy=0;this.memory[f].left=0;this.memory[f].top=0;this.memory[f].width=0;this.memory[f].height=0;this.memory[f].xpoints=[];this.memory[f].ypoints=[];e.label=document.createElement("DIV");this.pic_container.appendChild(e.label);e.label.className=this.config.label_class;this.assignCSS(e.label,this.config.label_style);e.label.style.position="absolute"};c.prototype.relaxArea=function(e){var d=this.areas[e];if(!d){return}if(e!=this.currentid){this._setBorder(d,"NORM");this._setopacity(d,this.config.CL_NORM_BG,this.config.norm_opacity)}else{this.highlightArea(e)}};c.prototype._setBorder=function(e,d){if(e.shape=="rect"||this.config.bounding_box){e.style.borderWidth="1px";e.style.borderStyle=(d=="DRAW"?"dotted":"solid");e.style.borderColor=this.config["CL_"+d+"_"+(e.shape=="rect"?"SHAPE":"BOX")]}else{e.style.border=""}};c.prototype._setopacity=function(e,d,f){if(d){e.style.backgroundColor=d}if(f&&typeof f=="string"&&f.match(/^\d*\-\d+$/)){var i=f.split("-");if(typeof i[0]!="undefined"){i[0]=parseInt(i[0],10);this._setopacity(e,d,i[0])}if(typeof i[1]!="undefined"){i[1]=parseInt(i[1],10);var h=this._getopacity(e);var j=this;var g=Math.round(i[1]-h);if(g>5){b.setTimeout(function(){j._setopacity(e,null,"-"+i[1])},20);f=1*h+5}else{if(g<-3){b.setTimeout(function(){j._setopacity(e,null,"-"+i[1])},20);f=1*h-3}else{f=i[1]}}}}if(!isNaN(f)){f=Math.round(parseInt(f,10));e.style.opacity=f/100;e.style.filter="alpha(opacity="+f+")"}};c.prototype._getopacity=function(d){if(d.style.opacity<=1){return d.style.opacity*100}if(d.style.filter){return parseInt(d.style.filter.replace(/alpha\(opacity\=([^\)]*)\)/ig,"$1"),10)}return 100};c.prototype.removeArea=function(e){if(e===null||typeof e=="undefined"){return}try{this.areas[e].label.parentNode.removeChild(this.areas[e].label);this.areas[e].parentNode.removeChild(this.areas[e]);this.areas[e].label.className=null;this.areas[e].label=null;this.areas[e].onmouseover=null;this.areas[e].onmouseout=null;this.areas[e].onmouseup=null;this.areas[e].onmousedown=null;this.areas[e].onmousemove=null}catch(d){}this.areas[e]=null;this.fireEvent("onRemoveArea",e)};c.prototype.removeAllAreas=function(){for(var e=0,d=this.areas.length;e<d;e++){if(this.areas[e]){this.removeArea(e)}}};c.prototype.scaleAllAreas=function(g){var f=g/this.globalscale;this.globalscale=g;for(var e=0,d=this.areas.length;e<d;e++){if(this.areas[e]&&this.areas[e].shape!="undefined"){this.scaleArea(e,f)}}};c.prototype.scaleArea=function(h,g){var f=this.areas[h];f.style.top=parseInt(f.style.top,10)*g+"px";f.style.left=parseInt(f.style.left,10)*g+"px";this.setAreaSize(h,f.width*g,f.height*g);if(f.shape=="poly"){for(var e=0,d=f.xpoints.length;e<d;e++){f.xpoints[e]*=g;f.ypoints[e]*=g}}this._repaint(f,this.config.CL_NORM_SHAPE);this._updatecoords(h)};c.prototype._putlabel=function(g){var f=this.areas[g];if(!f.label){return}try{if(!this.config.label){f.label.innerHTML="";f.label.style.display="none"}else{f.label.style.display="";var d=this.config.label;d=d.replace(/%n/g,String(g));d=d.replace(/%c/g,String(f.lastInput));d=d.replace(/%h/g,String(f.ahref));d=d.replace(/%a/g,String(f.aalt));d=d.replace(/%t/g,String(f.atitle));f.label.innerHTML=d}f.label.style.top=f.style.top;f.label.style.left=f.style.left}catch(e){this.log("Error putting label",1)}};c.prototype._puthint=function(f){try{if(!this.config.hint){this.areas[f].title="";this.areas[f].alt=""}else{var e=this.config.hint;e=e.replace(/%n/g,String(f));e=e.replace(/%c/g,String(this.areas[f].lastInput));e=e.replace(/%h/g,String(this.areas[f].ahref));e=e.replace(/%a/g,String(this.areas[f].aalt));e=e.replace(/%t/g,String(this.areas[f].atitle));this.areas[f].title=e;this.areas[f].alt=e}}catch(d){this.log("Error putting hint",1)}};c.prototype._repaintAll=function(){for(var e=0,d=this.areas.length;e<d;e++){if(this.areas[e]){this._repaint(this.areas[e],this.config.CL_NORM_SHAPE)}}};c.prototype._repaint=function(e,h,n,m){var p;var f,o,g,l;var j,d;if(e.shape=="circle"){f=parseInt(e.style.width,10);var k=Math.floor(f/2)-1;if(k<0){k=0}p=e.getContext("2d");p.clearRect(0,0,f,f);p.beginPath();p.strokeStyle=h;p.arc(k,k,k,0,Math.PI*2,0);p.stroke();p.closePath();p.strokeStyle=this.config.CL_KNOB;p.strokeRect(k,k,1,1);this._putlabel(e.aid);this._puthint(e.aid)}else{if(e.shape=="rect"){this._putlabel(e.aid);this._puthint(e.aid)}else{if(e.shape=="poly"){f=parseInt(e.style.width,10);o=parseInt(e.style.height,10);g=parseInt(e.style.left,10);l=parseInt(e.style.top,10);if(e.xpoints){p=e.getContext("2d");p.clearRect(0,0,f,o);p.beginPath();p.strokeStyle=h;p.moveTo(e.xpoints[0]-g,e.ypoints[0]-l);for(j=1,d=e.xpoints.length;j<d;j++){p.lineTo(e.xpoints[j]-g,e.ypoints[j]-l)}if(this.is_drawing==this.DM_POLYGON_DRAW||this.is_drawing==this.DM_POLYGON_LASTDRAW){p.lineTo(n-g,m-l)}p.lineTo(e.xpoints[0]-g,e.ypoints[0]-l);p.stroke();p.closePath()}this._putlabel(e.aid);this._puthint(e.aid)}}}};c.prototype._updatecoords=function(e){var f=this.areas[e];var h=Math.round(parseInt(f.style.left,10)/this.globalscale);var l=Math.round(parseInt(f.style.top,10)/this.globalscale);var n=Math.round(parseInt(f.style.height,10)/this.globalscale);var g=Math.round(parseInt(f.style.width,10)/this.globalscale);var m="";if(f.shape=="rect"){m=h+","+l+","+(h+g)+","+(l+n);f.lastInput=m}else{if(f.shape=="circle"){var k=Math.floor(g/2)-1;m=(h+k)+","+(l+k)+","+k;f.lastInput=m}else{if(f.shape=="poly"){if(f.xpoints){for(var j=0,d=f.xpoints.length;j<d;j++){m+=Math.round(f.xpoints[j]/this.globalscale)+","+Math.round(f.ypoints[j]/this.globalscale)+","}m=m.substring(0,m.length-1)}f.lastInput=m}}}this.fireEvent("onAreaChanged",f)};c.prototype._recalculate=function(e,m){var f=this.areas[e];try{if(m){m=this._normCoords(m,f.shape,"preserve")}else{m=f.lastInput||""}var k=m.split(",");if(f.shape=="rect"){if(k.length!=4||parseInt(k[0],10)>parseInt(k[2],10)||parseInt(k[1],10)>parseInt(k[3],10)){throw"invalid coords"}f.style.left=this.globalscale*(this.pic.offsetLeft+parseInt(k[0],10))+"px";f.style.top=this.globalscale*(this.pic.offsetTop+parseInt(k[1],10))+"px";this.setAreaSize(e,this.globalscale*(k[2]-k[0]),this.globalscale*(k[3]-k[1]));this._repaint(f,this.config.CL_NORM_SHAPE)}else{if(f.shape=="circle"){if(k.length!=3||parseInt(k[2],10)<0){throw"invalid coords"}var g=2*(k[2]);this.setAreaSize(e,this.globalscale*g,this.globalscale*g);f.style.left=this.globalscale*(this.pic.offsetLeft+parseInt(k[0],10)-g/2)+"px";f.style.top=this.globalscale*(this.pic.offsetTop+parseInt(k[1],10)-g/2)+"px";this._repaint(f,this.config.CL_NORM_SHAPE)}else{if(f.shape=="poly"){if(k.length<2){throw"invalid coords"}f.xpoints=[];f.ypoints=[];for(var l=0,d=k.length;l<d;l+=2){f.xpoints[f.xpoints.length]=this.globalscale*(this.pic.offsetLeft+parseInt(k[l],10));f.ypoints[f.ypoints.length]=this.globalscale*(this.pic.offsetTop+parseInt(k[l+1],10));this._polygongrow(f,this.globalscale*k[l],this.globalscale*k[l+1])}this._polygonshrink(f)}}}}catch(j){var h=(j.message)?j.message:"error calculating coordinates";this.log(h,1);this.statusMessage(this.strings.ERR_INVALID_COORDS);if(f.lastInput){this.fireEvent("onAreaChanged",f)}this._repaint(f,this.config.CL_NORM_SHAPE);return}f.lastInput=m};c.prototype._polygongrow=function(e,j,i){var d=j-parseInt(e.style.left,10);var h=i-parseInt(e.style.top,10);var g=0;var f=0;if(j<parseInt(e.style.left,10)){e.style.left=(j-g)+"px";this.setAreaSize(e.aid,parseInt(e.style.width,10)+Math.abs(d)+f,null)}else{if(j>parseInt(e.style.left,10)+parseInt(e.style.width,10)){this.setAreaSize(e.aid,j-parseInt(e.style.left,10)+f,null)}}if(i<parseInt(e.style.top,10)){e.style.top=(i-g)+"px";this.setAreaSize(e.aid,null,parseInt(e.style.height,10)+Math.abs(h)+f)}else{if(i>parseInt(e.style.top,10)+parseInt(e.style.height,10)){this.setAreaSize(e.aid,null,i-parseInt(e.style.top,10)+f)}}};c.prototype._polygonshrink=function(f){f.style.left=(f.xpoints[0])+"px";f.style.top=(f.ypoints[0])+"px";this.setAreaSize(f.aid,0,0);for(var e=0,d=f.xpoints.length;e<d;e++){this._polygongrow(f,f.xpoints[e],f.ypoints[e])}this._repaint(f,this.config.CL_NORM_SHAPE)};c.prototype.img_mousemove=function(m){var k,j,r;var n=this._getPos(this.pic),q=(this.isMSIE)?(b.event.x+this.pic_container.scrollLeft-this.pic.offsetLeft):(m.clientX-n.x),o=(this.isMSIE)?(b.event.y+this.pic_container.scrollTop-this.pic.offsetTop):(m.clientY-n.y);q=Math.round(q);o=Math.round(o);if(q<0||o<0||q>this.pic.width||o>this.pic.height){return}if(this.memory[this.currentid]){var p=this.memory[this.currentid].top;var h=this.memory[this.currentid].left;var s=this.memory[this.currentid].height;var g=this.memory[this.currentid].width}var f=this.areas[this.currentid];if(this.isSafari){if(m.shiftKey){if(this.is_drawing==this.DM_RECTANGLE_DRAW){this.is_drawing=this.DM_SQUARE_DRAW;this.statusMessage(this.strings.SQUARE2_DRAW)}}else{if(this.is_drawing==this.DM_SQUARE_DRAW&&f.shape=="rect"){this.is_drawing=this.DM_RECTANGLE_DRAW;this.statusMessage(this.strings.RECTANGLE_DRAW)}}}if(this.is_drawing==this.DM_RECTANGLE_DRAW){this.fireEvent("onDrawArea",this.currentid);k=q-this.memory[this.currentid].downx;j=o-this.memory[this.currentid].downy;this.setAreaSize(this.currentid,Math.abs(k),Math.abs(j));if(k<0){f.style.left=(q+1)+"px"}if(j<0){f.style.top=(o+1)+"px"}}else{if(this.is_drawing==this.DM_SQUARE_DRAW){this.fireEvent("onDrawArea",this.currentid);k=q-this.memory[this.currentid].downx;j=o-this.memory[this.currentid].downy;if(Math.abs(k)<Math.abs(j)){r=Math.abs(parseInt(k,10))}else{r=Math.abs(parseInt(j,10))}this.setAreaSize(this.currentid,r,r);if(k<0){f.style.left=(this.memory[this.currentid].downx+r*-1)+"px"}if(j<0){f.style.top=(this.memory[this.currentid].downy+r*-1+1)+"px"}}else{if(this.is_drawing==this.DM_POLYGON_DRAW){this.fireEvent("onDrawArea",this.currentid);this._polygongrow(f,q,o)}else{if(this.is_drawing==this.DM_RECTANGLE_MOVE||this.is_drawing==this.DM_SQUARE_MOVE){this.fireEvent("onMoveArea",this.currentid);q=q-this.memory[this.currentid].rdownx;o=o-this.memory[this.currentid].rdowny;if(q+g>this.pic.width||o+s>this.pic.height){return}if(q<0||o<0){return}f.style.left=q+1+"px";f.style.top=o+1+"px"}else{if(this.is_drawing==this.DM_POLYGON_MOVE){this.fireEvent("onMoveArea",this.currentid);q=q-this.memory[this.currentid].rdownx;o=o-this.memory[this.currentid].rdowny;if(q+g>this.pic.width||o+s>this.pic.height){return}if(q<0||o<0){return}k=q-h;j=o-p;if(f.xpoints){for(var l=0,d=f.xpoints.length;l<d;l++){f.xpoints[l]=this.memory[this.currentid].xpoints[l]+k;f.ypoints[l]=this.memory[this.currentid].ypoints[l]+j}}f.style.left=q+"px";f.style.top=o+"px"}else{if(this.is_drawing==this.DM_SQUARE_RESIZE_LEFT){this.fireEvent("onResizeArea",this.currentid);r=q-h;if((g+(-1*r))>0){f.style.left=q+1+"px";f.style.top=(p+(r/2))+"px";this.setAreaSize(this.currentid,parseInt(g+(-1*r),10),parseInt(s+(-1*r),10))}else{this.memory[this.currentid].width=0;this.memory[this.currentid].height=0;this.memory[this.currentid].left=q;this.memory[this.currentid].top=o;this.is_drawing=this.DM_SQUARE_RESIZE_RIGHT}}else{if(this.is_drawing==this.DM_SQUARE_RESIZE_RIGHT){this.fireEvent("onResizeArea",this.currentid);r=q-h-g;if((g+(r))-1>0){f.style.top=(p+(-1*r/2))+"px";this.setAreaSize(this.currentid,(g+(r))-1,(s+(r)))}else{this.memory[this.currentid].width=0;this.memory[this.currentid].height=0;this.memory[this.currentid].left=q;this.memory[this.currentid].top=o;this.is_drawing=this.DM_SQUARE_RESIZE_LEFT}}else{if(this.is_drawing==this.DM_SQUARE_RESIZE_TOP){this.fireEvent("onResizeArea",this.currentid);r=o-p;if((g+(-1*r))>0){f.style.top=o+1+"px";f.style.left=(h+(r/2))+"px";this.setAreaSize(this.currentid,(g+(-1*r)),(s+(-1*r)))}else{this.memory[this.currentid].width=0;this.memory[this.currentid].height=0;this.memory[this.currentid].left=q;this.memory[this.currentid].top=o;this.is_drawing=this.DM_SQUARE_RESIZE_BOTTOM}}else{if(this.is_drawing==this.DM_SQUARE_RESIZE_BOTTOM){this.fireEvent("onResizeArea",this.currentid);r=o-p-s;if((g+(r))-1>0){f.style.left=(h+(-1*r/2))+"px";this.setAreaSize(this.currentid,(g+(r))-1,(s+(r))-1)}else{this.memory[this.currentid].width=0;this.memory[this.currentid].height=0;this.memory[this.currentid].left=q;this.memory[this.currentid].top=o;this.is_drawing=this.DM_SQUARE_RESIZE_TOP}}else{if(this.is_drawing==this.DM_RECTANGLE_RESIZE_LEFT){this.fireEvent("onResizeArea",this.currentid);k=q-h;if(g+(-1*k)>0){f.style.left=q+1+"px";this.setAreaSize(this.currentid,g+(-1*k),null)}else{this.memory[this.currentid].width=0;this.memory[this.currentid].left=q;this.is_drawing=this.DM_RECTANGLE_RESIZE_RIGHT}}else{if(this.is_drawing==this.DM_RECTANGLE_RESIZE_RIGHT){this.fireEvent("onResizeArea",this.currentid);k=q-h-g;if((g+(k))-1>0){this.setAreaSize(this.currentid,(g+(k))-1,null)}else{this.memory[this.currentid].width=0;this.memory[this.currentid].left=q;this.is_drawing=this.DM_RECTANGLE_RESIZE_LEFT}}else{if(this.is_drawing==this.DM_RECTANGLE_RESIZE_TOP){this.fireEvent("onResizeArea",this.currentid);j=o-p;if((s+(-1*j))>0){f.style.top=o+1+"px";this.setAreaSize(this.currentid,null,(s+(-1*j)))}else{this.memory[this.currentid].height=0;this.memory[this.currentid].top=o;this.is_drawing=this.DM_RECTANGLE_RESIZE_BOTTOM}}else{if(this.is_drawing==this.DM_RECTANGLE_RESIZE_BOTTOM){this.fireEvent("onResizeArea",this.currentid);j=o-p-s;if((s+(j))-1>0){this.setAreaSize(this.currentid,null,(s+(j))-1)}else{this.memory[this.currentid].height=0;this.memory[this.currentid].top=o;this.is_drawing=this.DM_RECTANGLE_RESIZE_TOP}}}}}}}}}}}}}}if(this.is_drawing){this._repaint(f,this.config.CL_DRAW_SHAPE,q,o);this._updatecoords(this.currentid)}};c.prototype.img_mouseup=function(f){var h=this._getPos(this.pic),d=(this.isMSIE)?(b.event.x+this.pic_container.scrollLeft-this.pic.offsetLeft):(f.clientX-h.x),g=(this.isMSIE)?(b.event.y+this.pic_container.scrollTop-this.pic.offsetTop):(f.clientY-h.y);d=Math.round(d);g=Math.round(g);if(this.is_drawing!=this.DM_RECTANGLE_DRAW&&this.is_drawing!=this.DM_SQUARE_DRAW&&this.is_drawing!=this.DM_POLYGON_DRAW&&this.is_drawing!=this.DM_POLYGON_LASTDRAW){this.draggedId=null;this.is_drawing=0;this.statusMessage(this.strings.READY);this.relaxArea(this.currentid);if(this.areas[this.currentid]==this._getLastArea()){return}this.memory[this.currentid].downx=d;this.memory[this.currentid].downy=g}};c.prototype.img_mousedown=function(g){if(!g){g=b.event}var i=this._getPos(this.pic),d=Math.round(g.clientX-i.x),h=Math.round(g.clientY-i.y);if(g.shiftKey){if(this.is_drawing==this.DM_POLYGON_DRAW){this.is_drawing=this.DM_POLYGON_LASTDRAW}}var f=this.areas[this.currentid];if(this.is_drawing==this.DM_POLYGON_DRAW){f.xpoints[f.xpoints.length]=d;f.ypoints[f.ypoints.length]=h;this.memory[this.currentid].downx=d;this.memory[this.currentid].downy=h;return}else{if(this.is_drawing&&this.is_drawing!=this.DM_POLYGON_DRAW){if(this.is_drawing==this.DM_POLYGON_LASTDRAW){f.xpoints[f.xpoints.length]=d;f.ypoints[f.ypoints.length]=h;this._updatecoords(this.currentid);this.is_drawing=0;this._polygonshrink(f)}this.is_drawing=0;this.statusMessage(this.strings.READY);this.relaxArea(this.currentid);if(this.areas[this.currentid]==this._getLastArea()){return}return}}if(!this.nextShape){return}this.addNewArea();this.initArea(this.currentid,this.nextShape);if(this.areas[this.currentid].shape=="poly"){this.is_drawing=this.DM_POLYGON_DRAW;this.statusMessage(this.strings.POLYGON_DRAW);this.areas[this.currentid].style.left=d+"px";this.areas[this.currentid].style.top=h+"px";this.areas[this.currentid].style.width=0;this.areas[this.currentid].style.height=0;this.areas[this.currentid].xpoints=[];this.areas[this.currentid].ypoints=[];this.areas[this.currentid].xpoints[0]=d;this.areas[this.currentid].ypoints[0]=h}else{if(this.areas[this.currentid].shape=="rect"){this.is_drawing=this.DM_RECTANGLE_DRAW;this.statusMessage(this.strings.RECTANGLE_DRAW);this.areas[this.currentid].style.left=d+"px";this.areas[this.currentid].style.top=h+"px";this.areas[this.currentid].style.width=0;this.areas[this.currentid].style.height=0}else{if(this.areas[this.currentid].shape=="circle"){this.is_drawing=this.DM_SQUARE_DRAW;this.statusMessage(this.strings.SQUARE_DRAW);this.areas[this.currentid].style.left=d+"px";this.areas[this.currentid].style.top=h+"px";this.areas[this.currentid].style.width=0;this.areas[this.currentid].style.height=0}}}this._setBorder(this.areas[this.currentid],"DRAW");this.memory[this.currentid].downx=d;this.memory[this.currentid].downy=h};c.prototype.highlightArea=function(e){if(this.is_drawing){return}var d=this.areas[e];if(d&&d.shape!="undefined"){this._setBorder(d,"HIGHLIGHT");this._setopacity(d,this.config.CL_HIGHLIGHT_BG,"-"+this.config.highlight_opacity);this._repaint(d,this.config.CL_HIGHLIGHT_SHAPE)}};c.prototype.blurArea=function(e){if(this.is_drawing){return}var d=this.areas[e];if(d&&d.shape!="undefined"){this._setBorder(d,"NORM");this._setopacity(d,this.config.CL_NORM_BG,"-"+this.config.norm_opacity);this._repaint(d,this.config.CL_NORM_SHAPE)}};c.prototype.area_mousemove=function(m){if(!this.is_drawing){if(!m){m=b.event}var l=(this.isMSIE)?b.event.srcElement:m.currentTarget;if(l.tagName=="DIV"){l=l.parentNode}if(l.tagName=="image"||l.tagName=="group"||l.tagName=="shape"||l.tagName=="stroke"){l=l.parentNode.parentNode}var n=m.target||m.srcElement,o=n&&n.getBoundingClientRect();var j=o?m.clientX-o.left:b.event.offsetX;var h=o?m.clientY-o.top:b.event.offsetY;if(CKEDITOR.env.webkit){j-=b.scrollX;h-=b.scrollY}var f=(l.shape=="rect"||l.shape=="circle");if(f&&j<6&&h>6){l.style.cursor="w-resize"}else{if(f&&j>parseInt(l.style.width,10)-6&&h>6){l.style.cursor="e-resize"}else{if(f&&j>6&&h<6){l.style.cursor="n-resize"}else{if(f&&h>parseInt(l.style.height,10)-6&&j>6){l.style.cursor="s-resize"}else{l.style.cursor="move"}}}}if(l.aid!=this.draggedId){if(l.style.cursor=="move"){l.style.cursor="default"}return}var g=this.areas[this.currentid];if(j<6&&h>6){if(g.shape=="circle"){this.is_drawing=this.DM_SQUARE_RESIZE_LEFT;this.statusMessage(this.strings.SQUARE_RESIZE_LEFT)}else{if(g.shape=="rect"){this.is_drawing=this.DM_RECTANGLE_RESIZE_LEFT;this.statusMessage(this.strings.RECTANGLE_RESIZE_LEFT)}}}else{if(j>parseInt(g.style.width,10)-6&&h>6){if(g.shape=="circle"){this.is_drawing=this.DM_SQUARE_RESIZE_RIGHT;this.statusMessage(this.strings.SQUARE_RESIZE_RIGHT)}else{if(g.shape=="rect"){this.is_drawing=this.DM_RECTANGLE_RESIZE_RIGHT;this.statusMessage(this.strings.RECTANGLE_RESIZE_RIGHT)}}}else{if(j>6&&h<6){if(g.shape=="circle"){this.is_drawing=this.DM_SQUARE_RESIZE_TOP;this.statusMessage(this.strings.SQUARE_RESIZE_TOP)}else{if(g.shape=="rect"){this.is_drawing=this.DM_RECTANGLE_RESIZE_TOP;this.statusMessage(this.strings.RECTANGLE_RESIZE_TOP)}}}else{if(h>parseInt(g.style.height,10)-6&&j>6){if(g.shape=="circle"){this.is_drawing=this.DM_SQUARE_RESIZE_BOTTOM;this.statusMessage(this.strings.SQUARE_RESIZE_BOTTOM)}else{if(g.shape=="rect"){this.is_drawing=this.DM_RECTANGLE_RESIZE_BOTTOM;this.statusMessage(this.strings.RECTANGLE_RESIZE_BOTTOM)}}}else{if(g.shape=="circle"){this.is_drawing=this.DM_SQUARE_MOVE;this.statusMessage(this.strings.SQUARE_MOVE);this.memory[this.currentid].rdownx=j;this.memory[this.currentid].rdowny=h}else{if(g.shape=="rect"){this.is_drawing=this.DM_RECTANGLE_MOVE;this.statusMessage(this.strings.RECTANGLE_MOVE);this.memory[this.currentid].rdownx=j;this.memory[this.currentid].rdowny=h}else{if(g.shape=="poly"){if(g.xpoints){for(var k=0,d=g.xpoints.length;k<d;k++){this.memory[this.currentid].xpoints[k]=g.xpoints[k];this.memory[this.currentid].ypoints[k]=g.ypoints[k]}}if(g.shape=="poly"){this.is_drawing=this.DM_POLYGON_MOVE;this.statusMessage(this.strings.POLYGON_MOVE)}this.memory[this.currentid].rdownx=j;this.memory[this.currentid].rdowny=h}}}}}}}this.memory[this.currentid].width=parseInt(g.style.width,10);this.memory[this.currentid].height=parseInt(g.style.height,10);this.memory[this.currentid].top=parseInt(g.style.top,10);this.memory[this.currentid].left=parseInt(g.style.left,10);this._setBorder(g,"DRAW");this._setopacity(g,this.config.CL_DRAW_BG,this.config.draw_opacity)}else{this.img_mousemove(m)}};c.prototype.area_mouseup=function(f){if(!this.is_drawing){var d=(this.isMSIE)?b.event.srcElement:f.currentTarget;if(d.tagName=="DIV"){d=d.parentNode}if(d.tagName=="image"||d.tagName=="group"||d.tagName=="shape"||d.tagName=="stroke"){d=d.parentNode.parentNode}if(this.areas[this.currentid]!=d){if(typeof d.aid=="undefined"){this.log("Cannot identify target area",1);return}}this.draggedId=null}else{this.img_mouseup(f)}};c.prototype.area_mouseover=function(f){if(!this.is_drawing){var d=(this.isMSIE)?b.event.srcElement:f.currentTarget;if(d.tagName=="DIV"){d=d.parentNode}if(d.tagName=="image"||d.tagName=="group"||d.tagName=="shape"||d.tagName=="stroke"){d=d.parentNode.parentNode}this.highlightArea(d.aid)}};c.prototype.area_mouseout=function(g){if(!this.is_drawing){if(!g){g=b.event}if(this.isMSIE){if(g.toElement&&g.srcElement==g.toElement.parentNode){return}}var f=(this.isMSIE)?g.srcElement:g.currentTarget;var d=f.tagName.toLowerCase();if(d=="div"){f=f.parentNode}if(d=="image"||d=="group"||d=="shape"||d=="stroke"){f=f.parentNode.parentNode}if(this.currentid!=f.aid){this.blurArea(f.aid)}}};c.prototype.area_mousedown=function(f){if(!this.is_drawing){var d=(this.isMSIE)?b.event.srcElement:f.currentTarget;if(d.tagName=="DIV"){d=d.parentNode}if(d.tagName=="image"||d.tagName=="group"||d.tagName=="shape"||d.tagName=="stroke"){d=d.parentNode.parentNode}if(this.areas[this.currentid]!=d){if(typeof d.aid=="undefined"){this.log("Cannot identify target area",1);return}this.blurArea(this.currentid);this.currentid=d.aid;this.highlightArea(d.aid)}this.draggedId=this.currentid;this.selectedId=this.currentid;this.fireEvent("onSelectArea",this.areas[this.currentid]);if(this.isMSIE){b.event.cancelBubble=true}else{f.stopPropagation()}}else{this.img_mousedown(f)}};c.prototype.doc_keydown=function(f){var d=(this.isMSIE)?event.keyCode:f.keyCode;if(d==46){if(this.selectedId!==null&&!this.is_drawing){this.removeArea(this.selectedId)}}else{if(d==16){if(this.is_drawing==this.DM_RECTANGLE_DRAW){this.is_drawing=this.DM_SQUARE_DRAW;this.statusMessage(this.strings.SQUARE2_DRAW)}}}};c.prototype.doc_keyup=function(f){var d=(this.isMSIE)?event.keyCode:f.keyCode;if(d==16){if(this.is_drawing==this.DM_SQUARE_DRAW&&this.areas[this.currentid].shape=="rect"){this.is_drawing=this.DM_RECTANGLE_DRAW;this.statusMessage(this.strings.RECTANGLE_DRAW)}}};c.prototype.doc_mousedown=function(d){if(!this.is_drawing){this.selectedId=null}};c.prototype._getPos=function(d){var e=d.getBoundingClientRect();return{x:e.left,y:e.top}};c.prototype._getLastArea=function(){for(var d=this.areas.length-1;d>=0;d--){if(this.areas[d]){return this.areas[d]}}return null};c.prototype.assignCSS=function(l,g){var k=g.split(";");for(var f=0;f<k.length;f++){var h=k[f].split(":");var d=a(h[0]).split("-");var m=d[0];for(var e=1;e<d.length;e++){m+=d[e].replace(/^\w/,d[e].substring(0,1).toUpperCase())}l.style[a(m)]=a(h[1])}};c.prototype.fireEvent=function(d,e){if(typeof this.config.custom_callbacks[d]=="function"){return this.config.custom_callbacks[d](e)}};c.prototype.setAreaSize=function(g,d,e){if(g===null){g=this.currentid}var f=this.areas[g];if(d!==null){f.width=d;f.style.width=(d)+"px";f.setAttribute("width",d)}if(e!==null){f.height=e;f.style.height=(e)+"px";f.setAttribute("height",e)}};c.prototype.disableSelection=function(d){if(typeof d=="undefined"||!d){return false}if(typeof d.onselectstart!="undefined"){d.onselectstart=function(){return false}}if(typeof d.unselectable!="undefined"){d.unselectable="on"}if(typeof d.style.MozUserSelect!="undefined"){d.style.MozUserSelect="none"}};Function.prototype.bind=function(d){var e=this;return function(){return e.apply(d,arguments)}};function a(d){return d.replace(/^\s+|\s+$/g,"")}})(window);