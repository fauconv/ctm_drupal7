
(function(){CKEDITOR.plugins.add("imagemaps",{requires:["dialog"],lang:["en","de","el","es","fr","it","nl","sv","tr"],icons:"imagemaps",init:function(e){var d=this.path+"icons/imagemaps.png",f=e.lang.imagemaps;window.imgmapStrings=f.imgmapStrings;CKEDITOR.tools.extend(window.imgmapStrings,{READY:"",RECTANGLE_MOVE:"",RECTANGLE_RESIZE_TOP:"",RECTANGLE_RESIZE_RIGHT:"",RECTANGLE_RESIZE_BOTTOM:"",RECTANGLE_RESIZE_LEFT:"",SQUARE_DRAW:"",SQUARE_MOVE:"",SQUARE_RESIZE_TOP:"",SQUARE_RESIZE_RIGHT:"",SQUARE_RESIZE_BOTTOM:"",SQUARE_RESIZE_LEFT:"",POLYGON_MOVE:""});CKEDITOR.dialog.add("ImageMaps",this.path+"dialog/imagemaps.js");var a=e.addCommand("imagemaps",new CKEDITOR.dialogCommand("ImageMaps",{allowedContent:"img[usemap];map[id,name];area[alt,coords,href,shape,target,title]",requiredContent:"img[src]"}));a.startDisabled=true;e.ui.addButton("ImageMaps",{label:f.toolbar,command:"imagemaps",icon:d,toolbar:"insert,10"});if(e.addMenuItems){e.addMenuItems({imagemaps:{label:f.menu,command:"imagemaps",icon:d,group:"image",order:1}})}if(e.contextMenu){e.contextMenu.addListener(function(h,i){var g=b(h);if(!g){return null}return{imagemaps:(g.hasAttribute("usemap")?CKEDITOR.TRISTATE_ON:CKEDITOR.TRISTATE_OFF)}})}e.on("doubleclick",function(g){var i=g.data.element,j=g.editor,h;if(i.is("area")){var l=i.getParent().$,m=l.getAttribute("id"),k=j.editable?j.editable().$:j.document.$;if(k.querySelector){h=k.querySelector('img[usemap="#'+m+'"]')}if(h){j.getSelection().selectElement(new CKEDITOR.dom.element(h));g.data.dialog="ImageMaps";return}}h=b(i);if(h&&h.hasAttribute("usemap")){j.getSelection().selectElement(h);g.data.dialog="ImageMaps"}},null,null,20);if(e.widgets){e.on("contentDom",function(){var g=e.editable();g.attachListener(g,"click",function(o){var l=o.data.$,h=l.target||l.srcElement,k=new CKEDITOR.dom.node(h);if(k.is&&k.is("area")){if(CKEDITOR.env.ie){o.data.preventDefault()}var i=k.getParent().$,j=i.getAttribute("id"),p=g.$;if(p.querySelector){var m=p.querySelector('img[usemap="#'+j+'"]');if(m){var n=e.widgets.getByElement(new CKEDITOR.dom.node(m));if(n){n.focus();o.data.preventDefault()}}}}})})}var b=function(h){if(e.widgets){var j=e.widgets.focused;if(j&&(j.name=="image2"||j.name=="image")){var i=j.element;if(!i){return null}if(i.getName()=="img"){return i}var g=i.getElementsByTag("img");if(g.count()==1){return g.getItem(0)}return null}}if(!h||!h.is("img")||(h.data&&h.data("cke-realelement"))||h.isReadOnly()){return null}return h};e.on("selectionChange",CKEDITOR.tools.bind(function(g){var k=g.editor,j=g.data.path,i=j.lastElement;var h=b(i);if(!h){this.setState(CKEDITOR.TRISTATE_DISABLED);return}this.setState(h.hasAttribute("usemap")?CKEDITOR.TRISTATE_ON:CKEDITOR.TRISTATE_OFF)},a));if(CKEDITOR.env.ie&&!e.plugins.image2&&CKEDITOR.env.version<9){return}CKEDITOR.on("dialogDefinition",function(h){if(h.data.name!="image"){return}var g=h.data.definition;h.removeListener();g.onOk=CKEDITOR.tools.override(g.onOk,function(i){return function(){i.call(this);var j=this.imageElement,k=j.getAttribute("usemap");if(!k){return}var m=e.editable?e.editable().$:e.document.$,l=m.querySelector(k);if(!l){return}CKEDITOR.plugins.imagemaps.drawMap(j.$,l)}})});var c="dataReady";if(CKEDITOR.skins){c="contentDom"}e.on(c,function(n){var k=n.editor,m=k.editable?k.editable().$:k.document.$,o=m.getElementsByTagName("map");for(var j=0;j<o.length;j++){var l=o[j],h=l.name,g=m.querySelector('img[usemap="#'+h+'"]');if(g){CKEDITOR.plugins.imagemaps.drawMap(g,l)}}},null,null,50);if(!CKEDITOR.plugins.imagemaps){CKEDITOR.plugins.imagemaps={}}CKEDITOR.plugins.imagemaps.drawMap=function(q,g,m){if(!q.width){var s=function(i){q.removeEventListener("load",s);CKEDITOR.plugins.imagemaps.drawMap(q,g)};q.addEventListener("load",s,false);return}if(!m){if(q.attributes["data-cke-saved-src"]){var n=new Image();n.width=q.width;n.height=q.height;n.onload=function(){CKEDITOR.plugins.imagemaps.drawMap(q,g,n)};n.src=q.attributes["data-cke-saved-src"].value;return}else{m=q}}var u=q.ownerDocument,l=u.createElement("canvas"),k=l.getContext("2d");l.setAttribute("width",q.width);l.setAttribute("height",q.height);k.drawImage(m,0,0,q.width,q.height);k.strokeStyle="#DDDDDD";k.lineWidth=1;k.shadowOffsetX=0;k.shadowOffsetY=0;k.shadowBlur=3;k.shadowColor="#333333";for(var p=0;p<g.areas.length;p++){var h=g.areas[p],t=h.coords.split(",");switch(h.shape){case"circle":k.beginPath();k.arc(t[0],t[1],t[2],0,Math.PI*2,true);k.closePath();k.stroke();break;case"poly":k.beginPath();k.moveTo(t[0],t[1]);for(var o=2;o<t.length;o+=2){k.lineTo(t[o],t[o+1])}k.closePath();k.stroke();break;default:k.strokeRect(t[0],t[1],t[2]-t[0],t[3]-t[1]);break}}try{q.src=l.toDataURL()}catch(r){}}},afterInit:function(b){var a=b.dataProcessor,d=a&&a.htmlFilter,c=a&&a.dataFilter;d.addRules({elements:{map:function(f){if(f.attributes.id&&!f.attributes.name){f.attributes.name=f.attributes.id}var g=b.editable?b.editable().$:b.document.$;if(g.querySelector){var e=g.querySelector('img[usemap="#'+f.attributes.name+'"]');if(!e){return false}}return f}}},{applyToAll:true})}});if(CKEDITOR.skins){CKEDITOR.plugins.setLang=CKEDITOR.tools.override(CKEDITOR.plugins.setLang,function(a){return function(c,e,d){if(c!="devtools"&&typeof d[c]!="object"){var b={};b[c]=d;d=b}a.call(this,c,e,d)}})}delete CKEDITOR.dtd.$nonBodyContent.map;if(CKEDITOR.dtd.$body){CKEDITOR.dtd.$body.map=1}else{CKEDITOR.dtd.head.map=1}CKEDITOR.dtd.body.map=1})();